#  Copyright (c) University College London Hospitals NHS Foundation Trust
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
version: "3.8"


services:

  queue:
    container_name: pixl-test-queue
    image: rabbitmq:3.11.2-management
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "5672:5672"
      - "15672:15672"
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 10s
      retries: 5

  test:
    container_name: pixl-test-python
    build:
      context: ..
      dockerfile: tests/Dockerfile
    depends_on:
      queue:
        condition: service_healthy
      ftp-server:
        condition: service_healthy
    environment:
      RABBITMQ_USERNAME: guest
      RABBITMQ_PASSWORD: guest
      RABBITMQ_HOST: queue
      RABBITMQ_PORT: 5672
    entrypoint: "pytest"
  ftp-server:
#    image: stilliard/pure-ftpd
    container_name: test-ftp-server
    build:
      context: ftp-server
    ports:
      - "11121:21"
    volumes:
      # Mount for uploaded data
      - "./ftp-server/mounts/data/:/home/pixl/"
      # Mount SSL keys for TLS
      - "./ftp-server/mounts/ssl/:/etc/ssl/private/"
    environment:
      PUBLICHOST: "localhost"
      FTP_USER_NAME: pixl
      FTP_USER_PASS: pixl
      FTP_USER_HOME: /home/pixl
      # Enable TLS
      ADDED_FLAGS: "--tls=2"
    healthcheck:
      test: netstat -lnt | grep ":21" || exit 1
      interval: 10s
      timeout: 10s
      retries: 5