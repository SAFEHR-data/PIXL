# Alembic configuration

We've followed the  [alembic tutorial](https://alembic.sqlalchemy.org/en/latest/tutorial.html),
there's a good explainer there of each of the files and directories. 

## Running migrations in production

This is automatically done when the pixl-imaging container is started, 
as the entry point is [migrate_and_run.sh](../scripts/migrate_and_run.sh).

## Creating a new migration after editing the database model

For convenience, the [autogenerate-migration.sh](autogenerate-migration.sh) has been made.

Which you can run giving a name for the migration like this:

```shell
cd alembic
./autogenerate-migration.sh "<Description of changes to models>"
```

- This creates a postgres container
- Runs the existing migrations
- Checks for differences between the SQLAlchemy [models](../../pixl_core/src/core/db/models.py) 
  and creates a new migration in [versions](versions)
- Takes down the postgres container

There's a couple of manual steps:

- Check the changes autogenerated and update to match your intention
- Commit the changes and review in a pull request as normal

## 'PIXL/pixl_imaging/alembic' Directory Contents

### Subdirectories

[versions](./versions/README.md)

### Files

alembic.ini

autogenerate-migration.sh

env.py

migrations.env

README.md

script.py.mako

