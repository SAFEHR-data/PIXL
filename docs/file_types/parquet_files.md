# Parquet files you might encounter throughout PIXL

## OMOP-ES files

From
[OMOP-ES](https://github.com/UCLH-Foundry/the-rolling-skeleton/blob/main/docs/design/100-day-design.md#data-flow-through-components)
we receive parquet files defining the data we need to export. These input files appear as 2 groups:

1. **Public** parquet files: have had identifiers removed and replaced with a sequential ID for the
   export
2. **Private** parquet files: map sequential identifiers to patient identifiers (e.g. MRNs,
   Accession numbers, NHS numbers)

## Radiology reports

In addition to the OMOP-ES files, the PIXL pipeline generates **Radiology** parquet files, which
contain the radiology reports for the given extract. These are generated by collecting all
_de-identified_ radiology reports for the given extract from the CogStack API.

The functionality for this is defined in the [EHR API](../../pixl_ehr/README.md), specifically in
[`PIXLDatabase.get_radiology_reports`](../../pixl_ehr/src/pixl_ehr/_databases.py), which queries the
PIXL database for the de-identified radiology reports of the current extract and collects them
in a single _parquet_ file together with the `image_identifier` and `procedure_occurrence_id`.

## Exporting (copying from OMOP ES)

As part of the PIXL pipeline, we copy the OMOP-ES public _parquet_ files  to an export directory, to
prepare them for upload to the DSH. The exporting details are in the
[`pixl_core` documentation](../../pixl_core/README.md#omop-es-files).

## Uploading to the DSH

The final step in the journey of the _parquet_ files is to upload them to the DSH. This is
implemented and documented in [`pixl_core`](../../pixl_core/README.md#uploading-to-an-ftps-server).

## Testing

Various _parquet_ files are provided throughout the repo to enable unit and system testing:

- `cli/tests/resources/omop/` contains public and private parquet files together with an
  `extract_summary.json` file to mimic the input received from OMOP-ES for the unit tests
- `test/resources/omop/` contains public and private parquet files together with an
  `extract_summary.json` file to mimic the input received from OMOP-ES for the system tests

During the system test, a `radiology.parquet` file is generated and temporarily stored in
`exports/test-extract-uclh-omop-cdm/latest/radiology/radiology.parquet` to check the successful
de-identification before the DSH upload. This file is then deleted after the test.
